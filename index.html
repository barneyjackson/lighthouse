<!DOCTYPE html>
<html>
  <head>
    <!-- These 3 required for bootstrap to operate correctly -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="static/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/css/style.css">

    <!-- jQuery + bootstrap-->
    <script src="static/js/jquery-2.2.1.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> -->
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script> -->

    <!-- Babel to transpile js on the browser -->
    <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>-->
    <script src="static/js/browser.min.js"></script>

    <!-- React Things-->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.js"></script> -->
    <script src="static/js/react.js"></script>
    <script src="static/js/react-dom.js"></script>

    <title>Menu Administration</title>
  </head>
  <body>
    <div class="container">
      <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class="active"><a href="#">Home</a></li>
            <li role="presentation"><a href="#">About</a></li>
            <li role="presentation"><a href="#">Contact</a></li>
          </ul>
        </nav>
        <h3 class="text-muted">Refugee Camp Management</h3>
      </div>

    <div id="menuadmincontainer">
      <p>
        To install React, follow the instructions on
        <a href="https://github.com/facebook/react/">GitHub</a>.
      </p>
      <p>
        If you can see this, React is not working right.
        If you checked out the source from GitHub make sure to run <code>grunt</code>.
      </p>
    </div>
    <script type='text/babel'>

    // Initial state populated by props, and then props are never used again.
    // Pass back your state to your parent.
    var MenuComponent = React.createClass({

      componentWillMount: function() {
        this.setState({menu: this.props.menu, callback: this.props.callback})
      },

      handleChange: function(event) {
        const updatedMenu = Object.assign(this.state.menu)
        updatedMenu.description = event.target.value
        // Let our parent know that we are updated. Then, update our own state.
        // TODO(parth): can we actually flip these?
        this.state.callback(updatedMenu)
        this.setState({menu: updatedMenu})
      },

      handleStateChange: function(newChildMenu) {
        const currentMenuChildren = this.state.menu.children

        // Look for the menu in the list, and then update or add if necessary.
        const idx = currentMenuChildren.find(function(elem) {
          return elem.id == newChildMenu.id
        })

        if (idx == -1) {
          currentMenuChildren.push(newChildMenu)
        } else {
          currentMenuChildren[idx] = newChildMenu
        }

        const updatedMenu = Object.assign(this.state.menu)
        updatedMenu.children = currentMenuChildren

        // update our menu, then update our parents
        this.setState({menu: updatedMenu})
        this.state.callback(this.state.menu)
      },

      handleNewThing: function() {
        const currentMenuChildren = this.state.menu.children
        const updatedMenu = Object.assign(this.state.menu)
        // TODO(parth): need children:[] or no
        currentMenuChildren.push({"description": "Default Description"})
        updatedMenu.children = currentMenuChildren
        // update our menu, then update our parents
        this.setState({menu: updatedMenu})
        this.state.callback(this.state.menu)
      },

      render: function() {
        // Only use state! Never use props again.
        var menu = this.state.menu;
        var stack = this.state.stack;
        var handleStateChange = this.handleStateChange;
        return (
          <ol>
            <li><input className="form-control" type="text" onChange={this.handleChange} value={menu.description} /></li>
            <button className="btn btn-primary" onClick={this.handleNewThing}>add new item</button>
            {menu.children &&
              menu.children.map(function(menuItem, idx) {
                return <MenuComponent menu={menuItem} callback={handleStateChange}/>
              })
            }
          </ol>
        );
      }

    });

    var MenuContainer = React.createClass({

      getInitialState: function() {
        return {};
      },

      componentDidMount: function() {
        $.ajax({
          url: "http://localhost:5000/menu",
          dataType: 'json',
          cache: false,
          success: function(data) {
            console.log(data);
            this.setState({menu: data});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },

      handleCallback: function(updatedMenu) {
        console.log("new menu")
        console.log(updatedMenu)
        this.setState({menu: updatedMenu})
      },

      displaySuccess: function() {},
      displayError: function(errors) {},

      handleSubmit: function(updatedMenu) {
        console.log("doing put request: ")
        console.log(this.state.menu)
        $.ajax({
          url: 'http://localhost:5000/menu',
          contentType: "application/json; charset=utf-8",
          type: 'PUT',
          dataType: 'json',
          data: JSON.stringify(this.state.menu),
          //data: this.state.menu,
          success: function(data) {
            console.log("POST success");
            if (data.success) {
              displaySuccess()
            }
            if (data.error) {
              displayError(data.error)
            }
          }.bind(this),
          error: function(xhr, status, err) {
            console.log("error!")
          }
        });
      },

      render: function() {
        var a = {
        "description": "Some Meta Text",
        "children": [
            {"id": "a", "description": "1. Get info about food.", "children": [{"id": "d", "description": "1. More Food Info"}]},
            {"id": "b", "description": "2. Get info about housing.", "answer": "Zaatari"},
            {"id": "c", "description": "3. What's the name of this camp.", "answer": "Zaatari"}]
        };

        /*
        return (
          <div>
            <MenuComponent menu={a} callback={this.handleSubmit}/>
            <button onClick={this.handleSubmit}>submit dude</button>
          </div>
        );
        */
        var menu = this.state.menu;
        return (
          <div>
          {
            menu && (
              <div>
              <MenuComponent menu={menu} callback={this.handleCallback}/>
              <button className="btn btn-primary" onClick={this.handleSubmit}>submit dude</button>
              </div>
            )
          }
          </div>
        );
      }
    });

    ReactDOM.render(
      <MenuContainer />,
      document.getElementById('menuadmincontainer')
    );
    </script>
    </div>
  </body>
</html>
